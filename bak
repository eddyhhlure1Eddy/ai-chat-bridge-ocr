#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
è¯¦ç»†çš„æˆªå›¾é—®é¢˜è¯Šæ–­è„šæœ¬
"""

import sys
import os
import platform
import time

def test_basic_screenshot():
    """æµ‹è¯•åŸºç¡€æˆªå›¾åŠŸèƒ½"""
    print("ğŸ§ª æµ‹è¯•åŸºç¡€æˆªå›¾åŠŸèƒ½...")
    
    try:
        import pyautogui
        
        print(f"ğŸ“¦ pyautoguiç‰ˆæœ¬: {pyautogui.__version__}")
        
        # è·å–å±å¹•å°ºå¯¸
        screen_size = pyautogui.size()
        print(f"ğŸ“º å±å¹•å°ºå¯¸: {screen_size}")
        
        # æµ‹è¯•1: å…¨å±æˆªå›¾
        print("\nğŸ“¸ æµ‹è¯•1: å…¨å±æˆªå›¾...")
        pyautogui.FAILSAFE = False
        
        start_time = time.time()
        screenshot = pyautogui.screenshot()
        end_time = time.time()
        
        print(f"â±ï¸ æˆªå›¾è€—æ—¶: {end_time - start_time:.3f}ç§’")
        
        if screenshot:
            print(f"âœ… æˆªå›¾æˆåŠŸ: {screenshot.size}")
            print(f"ğŸ“Š å›¾åƒæ¨¡å¼: {screenshot.mode}")
            
            # ä¿å­˜æˆªå›¾
            screenshot.save("debug_full.png")
            print("ğŸ’¾ å…¨å±æˆªå›¾å·²ä¿å­˜: debug_full.png")
            
            # åˆ†æå›¾åƒå†…å®¹
            analyze_image(screenshot, "å…¨å±")
            
            return screenshot
        else:
            print("âŒ æˆªå›¾è¿”å›None")
            return None
            
    except Exception as e:
        print(f"âŒ åŸºç¡€æˆªå›¾æµ‹è¯•å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
        return None

def test_region_screenshot():
    """æµ‹è¯•åŒºåŸŸæˆªå›¾"""
    print("\nğŸ§ª æµ‹è¯•åŒºåŸŸæˆªå›¾åŠŸèƒ½...")
    
    try:
        import pyautogui
        
        # æµ‹è¯•ä¸åŒå¤§å°çš„åŒºåŸŸ
        test_regions = [
            (100, 100, 200, 200),  # å°åŒºåŸŸ
            (0, 0, 500, 300),      # å·¦ä¸Šè§’
            (200, 200, 400, 300),  # ä¸­é—´åŒºåŸŸ
        ]
        
        for i, region in enumerate(test_regions):
            print(f"\nğŸ“¸ æµ‹è¯•åŒºåŸŸ {i+1}: {region}")
            x, y, w, h = region
            
            try:
                start_time = time.time()
                screenshot = pyautogui.screenshot(region=region)
                end_time = time.time()
                
                print(f"â±ï¸ æˆªå›¾è€—æ—¶: {end_time - start_time:.3f}ç§’")
                
                if screenshot:
                    print(f"âœ… åŒºåŸŸæˆªå›¾æˆåŠŸ: {screenshot.size}")
                    
                    # ä¿å­˜æˆªå›¾
                    filename = f"debug_region_{i+1}.png"
                    screenshot.save(filename)
                    print(f"ğŸ’¾ åŒºåŸŸæˆªå›¾å·²ä¿å­˜: {filename}")
                    
                    # åˆ†æå›¾åƒå†…å®¹
                    analyze_image(screenshot, f"åŒºåŸŸ{i+1}")
                else:
                    print("âŒ åŒºåŸŸæˆªå›¾è¿”å›None")
                    
            except Exception as e:
                print(f"âŒ åŒºåŸŸ {i+1} æˆªå›¾å¤±è´¥: {e}")
                
    except Exception as e:
        print(f"âŒ åŒºåŸŸæˆªå›¾æµ‹è¯•å¤±è´¥: {e}")

def analyze_image(image, label):
    """åˆ†æå›¾åƒå†…å®¹"""
    try:
        import numpy as np
        
        # è½¬æ¢ä¸ºnumpyæ•°ç»„
        img_array = np.array(image)
        
        # åŸºæœ¬ç»Ÿè®¡
        print(f"ğŸ“Š {label}å›¾åƒåˆ†æ:")
        print(f"   å°ºå¯¸: {image.size}")
        print(f"   æ¨¡å¼: {image.mode}")
        print(f"   æ•°ç»„å½¢çŠ¶: {img_array.shape}")
        
        # é¢œè‰²ç»Ÿè®¡
        if len(img_array.shape) == 3:  # RGBå›¾åƒ
            r_mean = np.mean(img_array[:, :, 0])
            g_mean = np.mean(img_array[:, :, 1])
            b_mean = np.mean(img_array[:, :, 2])
            print(f"   RGBå¹³å‡å€¼: R={r_mean:.1f}, G={g_mean:.1f}, B={b_mean:.1f}")
            
            # æ£€æŸ¥æ˜¯å¦ä¸ºé»‘å±
            total_brightness = (r_mean + g_mean + b_mean) / 3
            print(f"   æ€»ä½“äº®åº¦: {total_brightness:.1f}")
            
            if total_brightness < 10:
                print("   âš ï¸ å¯èƒ½æ˜¯é»‘å±")
            elif total_brightness < 50:
                print("   âš ï¸ å›¾åƒè¾ƒæš—")
            else:
                print("   âœ… å›¾åƒäº®åº¦æ­£å¸¸")
                
            # æ£€æŸ¥é¢œè‰²åˆ†å¸ƒ
            unique_colors = len(np.unique(img_array.reshape(-1, img_array.shape[-1]), axis=0))
            print(f"   å”¯ä¸€é¢œè‰²æ•°: {unique_colors}")
            
            if unique_colors < 10:
                print("   âš ï¸ é¢œè‰²ç§ç±»å¾ˆå°‘ï¼Œå¯èƒ½æœ‰é—®é¢˜")
            else:
                print("   âœ… é¢œè‰²åˆ†å¸ƒæ­£å¸¸")
                
        elif len(img_array.shape) == 2:  # ç°åº¦å›¾åƒ
            mean_val = np.mean(img_array)
            print(f"   ç°åº¦å¹³å‡å€¼: {mean_val:.1f}")
            
            if mean_val < 10:
                print("   âš ï¸ å¯èƒ½æ˜¯é»‘å±")
            else:
                print("   âœ… å›¾åƒæ­£å¸¸")
                
    except Exception as e:
        print(f"âŒ å›¾åƒåˆ†æå¤±è´¥: {e}")

def test_alternative_methods():
    """æµ‹è¯•æ›¿ä»£æˆªå›¾æ–¹æ³•"""
    print("\nğŸ§ª æµ‹è¯•æ›¿ä»£æˆªå›¾æ–¹æ³•...")
    
    # æ–¹æ³•1: PIL ImageGrab
    try:
        print("\nğŸ“¸ æµ‹è¯•PIL ImageGrab...")
        from PIL import ImageGrab
        
        screenshot = ImageGrab.grab()
        if screenshot:
            print(f"âœ… PIL ImageGrabæˆåŠŸ: {screenshot.size}")
            screenshot.save("debug_pil.png")
            print("ğŸ’¾ PILæˆªå›¾å·²ä¿å­˜: debug_pil.png")
            analyze_image(screenshot, "PIL")
        else:
            print("âŒ PIL ImageGrabå¤±è´¥")
            
    except Exception as e:
        print(f"âŒ PIL ImageGrabæµ‹è¯•å¤±è´¥: {e}")
    
    # æ–¹æ³•2: ç³»ç»Ÿç‰¹å®šæ–¹æ³•
    system = platform.system()
    if system == "Windows":
        try:
            print("\nğŸ“¸ æµ‹è¯•Windowsç‰¹å®šæ–¹æ³•...")
            import win32gui
            import win32ui
            import win32con
            from PIL import Image
            
            # è·å–æ¡Œé¢çª—å£
            hwnd = win32gui.GetDesktopWindow()
            
            # è·å–çª—å£å°ºå¯¸
            left, top, right, bottom = win32gui.GetWindowRect(hwnd)
            width = right - left
            height = bottom - top
            
            print(f"ğŸ“º æ¡Œé¢çª—å£å°ºå¯¸: {width}x{height}")
            
            # åˆ›å»ºè®¾å¤‡ä¸Šä¸‹æ–‡
            hwndDC = win32gui.GetWindowDC(hwnd)
            mfcDC = win32ui.CreateDCFromHandle(hwndDC)
            saveDC = mfcDC.CreateCompatibleDC()
            
            # åˆ›å»ºä½å›¾
            saveBitMap = win32ui.CreateBitmap()
            saveBitMap.CreateCompatibleBitmap(mfcDC, width, height)
            saveDC.SelectObject(saveBitMap)
            
            # å¤åˆ¶å±å¹•å†…å®¹
            result = saveDC.BitBlt((0, 0), (width, height), mfcDC, (0, 0), win32con.SRCCOPY)
            
            if result:
                # è·å–ä½å›¾æ•°æ®
                bmpinfo = saveBitMap.GetInfo()
                bmpstr = saveBitMap.GetBitmapBits(True)
                
                # è½¬æ¢ä¸ºPILå›¾åƒ
                screenshot = Image.frombuffer(
                    'RGB',
                    (bmpinfo['bmWidth'], bmpinfo['bmHeight']),
                    bmpstr, 'raw', 'BGRX', 0, 1
                )
                
                print(f"âœ… Windows GDIæˆåŠŸ: {screenshot.size}")
                screenshot.save("debug_gdi.png")
                print("ğŸ’¾ GDIæˆªå›¾å·²ä¿å­˜: debug_gdi.png")
                analyze_image(screenshot, "GDI")
            else:
                print("âŒ Windows GDI BitBltå¤±è´¥")
            
            # æ¸…ç†èµ„æº
            win32gui.DeleteObject(saveBitMap.GetHandle())
            saveDC.DeleteDC()
            mfcDC.DeleteDC()
            win32gui.ReleaseDC(hwnd, hwndDC)
            
        except Exception as e:
            print(f"âŒ Windows GDIæµ‹è¯•å¤±è´¥: {e}")

def test_system_info():
    """æµ‹è¯•ç³»ç»Ÿä¿¡æ¯"""
    print("\nğŸ” ç³»ç»Ÿä¿¡æ¯æ£€æŸ¥...")
    
    # åŸºæœ¬ç³»ç»Ÿä¿¡æ¯
    print(f"ğŸ–¥ï¸ æ“ä½œç³»ç»Ÿ: {platform.system()} {platform.release()}")
    print(f"ğŸ Pythonç‰ˆæœ¬: {sys.version}")
    print(f"ğŸ“ å½“å‰ç›®å½•: {os.getcwd()}")
    
    # æ˜¾ç¤ºç›¸å…³ä¿¡æ¯
    try:
        import tkinter as tk
        root = tk.Tk()
        root.withdraw()
        
        screen_width = root.winfo_screenwidth()
        screen_height = root.winfo_screenheight()
        dpi = root.winfo_fpixels('1i')
        
        print(f"ğŸ“º Tkinterå±å¹•å°ºå¯¸: {screen_width}x{screen_height}")
        print(f"ğŸ“Š DPI: {dpi:.1f}")
        print(f"ğŸ“ ç¼©æ”¾æ¯”ä¾‹: {dpi/96:.2f}")
        
        root.destroy()
        
    except Exception as e:
        print(f"âŒ Tkinterä¿¡æ¯è·å–å¤±è´¥: {e}")
    
    # ç¯å¢ƒå˜é‡
    if platform.system() == "Linux":
        display = os.environ.get('DISPLAY')
        print(f"ğŸ–¥ï¸ DISPLAY: {display}")
    
    # æƒé™æ£€æŸ¥
    if platform.system() == "Darwin":  # macOS
        print("ğŸ macOSæƒé™æé†’:")
        print("   è¯·ç¡®ä¿å·²æˆäºˆå±å¹•å½•åˆ¶æƒé™")
        print("   ç³»ç»Ÿåå¥½è®¾ç½® > å®‰å…¨æ€§ä¸éšç§ > éšç§ > å±å¹•å½•åˆ¶")

def main():
    """ä¸»å‡½æ•°"""
    print("ğŸ”§ è¯¦ç»†æˆªå›¾é—®é¢˜è¯Šæ–­")
    print("=" * 50)
    
    # ç³»ç»Ÿä¿¡æ¯
    test_system_info()
    
    # åŸºç¡€æˆªå›¾æµ‹è¯•
    full_screenshot = test_basic_screenshot()
    
    # åŒºåŸŸæˆªå›¾æµ‹è¯•
    test_region_screenshot()
    
    # æ›¿ä»£æ–¹æ³•æµ‹è¯•
    test_alternative_methods()
    
    print("\n" + "=" * 50)
    print("ğŸ“Š è¯Šæ–­å®Œæˆ")
    
    # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
    debug_files = [f for f in os.listdir('.') if f.startswith('debug_') and f.endswith('.png')]
    
    if debug_files:
        print(f"\nğŸ“ ç”Ÿæˆçš„è°ƒè¯•æ–‡ä»¶: {len(debug_files)}ä¸ª")
        for file in debug_files:
            try:
                size = os.path.getsize(file)
                print(f"   {file}: {size} bytes")
            except:
                print(f"   {file}: æ— æ³•è·å–å¤§å°")
        
        print("\nğŸ’¡ è¯·æ£€æŸ¥è¿™äº›å›¾åƒæ–‡ä»¶æ¥åˆ¤æ–­æˆªå›¾æ˜¯å¦æ­£å¸¸")
    else:
        print("\nâŒ æ²¡æœ‰ç”Ÿæˆä»»ä½•æˆªå›¾æ–‡ä»¶")
    
    print("\nğŸ” å¦‚æœæ‰€æœ‰æˆªå›¾éƒ½æ˜¯é»‘å±ï¼Œå¯èƒ½çš„åŸå› :")
    print("   1. å±å¹•æƒé™é—®é¢˜ï¼ˆç‰¹åˆ«æ˜¯macOSï¼‰")
    print("   2. æ˜¾å¡é©±åŠ¨é—®é¢˜")
    print("   3. é«˜DPIç¼©æ”¾é—®é¢˜")
    print("   4. è™šæ‹Ÿæœºæˆ–è¿œç¨‹æ¡Œé¢ç¯å¢ƒ")
    print("   5. å®‰å…¨è½¯ä»¶é˜»æ­¢")
    
    # æ¸…ç†é€‰é¡¹
    response = input("\næ˜¯å¦åˆ é™¤è°ƒè¯•æ–‡ä»¶ï¼Ÿ(y/n): ").lower().strip()
    if response in ['y', 'yes', 'æ˜¯']:
        for file in debug_files:
            try:
                os.remove(file)
                print(f"ğŸ—‘ï¸ åˆ é™¤: {file}")
            except:
                pass
    
    input("\næŒ‰å›è½¦é”®é€€å‡º...")

if __name__ == "__main__":
    main()
